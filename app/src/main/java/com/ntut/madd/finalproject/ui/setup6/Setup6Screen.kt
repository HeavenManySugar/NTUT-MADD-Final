package com.ntut.madd.finalproject.ui.setup6

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.stringResource
import androidx.compose.ui.text.input.KeyboardCapitalization
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.lifecycle.compose.collectAsStateWithLifecycle
import com.ntut.madd.finalproject.R
import com.ntut.madd.finalproject.ui.setup.components.CompletionCelebration
import com.ntut.madd.finalproject.ui.setup.components.SetupPageContainer
import com.ntut.madd.finalproject.ui.theme.MakeItSoTheme
import kotlinx.coroutines.delay
import kotlinx.coroutines.launch
import kotlinx.serialization.Serializable

@Serializable
object Setup6Route

@Composable
fun Setup6Screen(
    onNext: () -> Unit,
    onBack: () -> Unit,
    viewModel: Setup6ViewModel = hiltViewModel()
) {
    val aboutMe by viewModel.aboutMe.collectAsStateWithLifecycle()
    val lookingFor by viewModel.lookingFor.collectAsStateWithLifecycle()
    val isFormValid by viewModel.isFormValid.collectAsStateWithLifecycle()
    
    val coroutineScope = rememberCoroutineScope()
    var showCelebration by remember { mutableStateOf(false) }
    var isSubmitting by remember { mutableStateOf(false) }

    Setup6ScreenContent(
        aboutMe = aboutMe,
        lookingFor = lookingFor,
        isFormValid = isFormValid,
        isSubmitting = isSubmitting,
        onAboutMeChange = viewModel::updateAboutMe,
        onLookingForChange = viewModel::updateLookingFor,
        getAboutMeCharacterCount = viewModel::getAboutMeCharacterCount,
        getLookingForCharacterCount = viewModel::getLookingForCharacterCount,
        onNext = {
            isSubmitting = true
            // Simulate form submission delay
            coroutineScope.launch {
                delay(1500) // Simulate processing
                isSubmitting = false
                showCelebration = true
            }
        },
        onBack = onBack
    )
    
    // Completion celebration overlay
    CompletionCelebration(
        visible = showCelebration,
        onDismiss = {
            showCelebration = false
            onNext()
        }
    )
}

@Composable
fun Setup6ScreenContent(
    aboutMe: String,
    lookingFor: String,
    isFormValid: Boolean,
    isSubmitting: Boolean = false,
    onAboutMeChange: (String) -> Unit,
    onLookingForChange: (String) -> Unit,
    getAboutMeCharacterCount: () -> String,
    getLookingForCharacterCount: () -> String,
    onNext: () -> Unit,
    onBack: () -> Unit
) {

    SetupPageContainer(
        currentStep = 6,
        totalSteps = 6,
        onBackClick = onBack,
        headerIcon = "üìù",
        headerTitle = stringResource(R.string.setup6_title),
        headerSubtitle = "ÂÆåÂñÑÊÇ®ÁöÑÂÄã‰∫∫Ê™îÊ°à",
        isFormValid = isFormValid,
        onNextClick = onNext,
        nextButtonText = R.string.setup6_complete_button,
        isLoading = isSubmitting,
        loadingText = "Ê≠£Âú®‰øùÂ≠òÊÇ®ÁöÑË®≠ÂÆö..."
    ) {
        Column(
            modifier = Modifier.fillMaxSize(),
            verticalArrangement = Arrangement.spacedBy(24.dp)
        ) {
            // ÈóúÊñºÊàëËº∏ÂÖ•ÂçÄÂüü
            Column(
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = stringResource(R.string.setup6_about_me_title),
                        style = MaterialTheme.typography.titleMedium,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    
                    // Âª∫Ë≠∞Â≠óÊï∏ÊèêÁ§∫
                    Text(
                        text = "Âª∫Ë≠∞ 50-500 Â≠ó",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                    )
                }
                
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color(0xFFF8F9FA)
                    ),
                    shape = RoundedCornerShape(12.dp),
                    elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
                ) {
                    OutlinedTextField(
                        value = aboutMe,
                        onValueChange = { if (it.length <= 500) onAboutMeChange(it) },
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(120.dp),
                        placeholder = { 
                            Text(
                                text = stringResource(R.string.setup6_about_me_placeholder),
                                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                            ) 
                        },
                        keyboardOptions = KeyboardOptions(
                            capitalization = KeyboardCapitalization.Sentences
                        ),
                        maxLines = 6,
                        colors = OutlinedTextFieldDefaults.colors(
                            unfocusedContainerColor = Color.Transparent,
                            focusedContainerColor = Color.Transparent,
                            unfocusedBorderColor = if (aboutMe.length < 50 && aboutMe.isNotEmpty()) 
                                Color(0xFFFF9800) else Color(0xFFEAECEF),
                            focusedBorderColor = when {
                                aboutMe.length >= 50 -> Color(0xFF4CAF50)
                                aboutMe.isNotEmpty() -> Color(0xFFFF9800)
                                else -> Color(0xFF6B46C1).copy(alpha = 0.5f)
                            },
                            cursorColor = Color(0xFF6B46C1)
                        )
                    )
                }
                
                // Â≠óÊï∏Áµ±Ë®àÂíåÂª∫Ë≠∞
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = when {
                            aboutMe.isEmpty() -> "ÈñãÂßã‰ªãÁ¥πÊÇ®Ëá™Â∑±ÂêßÔºÅ"
                            aboutMe.length < 50 -> "ÂèØ‰ª•ÂÜçÂ§öÂØ´‰∏Ä‰∫õÂì¶ÔºàËá≥Â∞ë50Â≠óÔºâ"
                            aboutMe.length >= 50 -> "Â§™Ê£í‰∫ÜÔºÅÂÖßÂÆπÂæàÂÖÖÂØ¶"
                            else -> ""
                        },
                        style = MaterialTheme.typography.bodySmall,
                        color = when {
                            aboutMe.isEmpty() -> MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                            aboutMe.length < 50 -> Color(0xFFFF9800)
                            else -> Color(0xFF4CAF50)
                        }
                    )
                    
                    Text(
                        text = "${aboutMe.length}/500",
                        style = MaterialTheme.typography.bodySmall,
                        color = when {
                            aboutMe.length > 450 -> Color(0xFFE53E3E)
                            aboutMe.length >= 50 -> Color(0xFF4CAF50)
                            else -> MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                        }
                    )
                }
            }

            // ÊàëÂú®Â∞ãÊâæËº∏ÂÖ•ÂçÄÂüü
            Column(
                verticalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = stringResource(R.string.setup6_looking_for_title),
                        style = MaterialTheme.typography.titleMedium,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                    
                    // Âª∫Ë≠∞Â≠óÊï∏ÊèêÁ§∫
                    Text(
                        text = "Âª∫Ë≠∞ 20-300 Â≠ó",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                    )
                }
                
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    colors = CardDefaults.cardColors(
                        containerColor = Color(0xFFF8F9FA)
                    ),
                    shape = RoundedCornerShape(12.dp),
                    elevation = CardDefaults.cardElevation(defaultElevation = 0.dp)
                ) {
                    OutlinedTextField(
                        value = lookingFor,
                        onValueChange = { if (it.length <= 300) onLookingForChange(it) },
                        modifier = Modifier
                            .fillMaxWidth()
                            .height(100.dp),
                        placeholder = { 
                            Text(
                                text = stringResource(R.string.setup6_looking_for_placeholder),
                                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                            ) 
                        },
                        keyboardOptions = KeyboardOptions(
                            capitalization = KeyboardCapitalization.Sentences
                        ),
                        maxLines = 4,
                        colors = OutlinedTextFieldDefaults.colors(
                            unfocusedContainerColor = Color.Transparent,
                            focusedContainerColor = Color.Transparent,
                            unfocusedBorderColor = if (lookingFor.length < 20 && lookingFor.isNotEmpty()) 
                                Color(0xFFFF9800) else Color(0xFFEAECEF),
                            focusedBorderColor = when {
                                lookingFor.length >= 20 -> Color(0xFF4CAF50)
                                lookingFor.isNotEmpty() -> Color(0xFFFF9800)
                                else -> Color(0xFF6B46C1).copy(alpha = 0.5f)
                            },
                            cursorColor = Color(0xFF6B46C1)
                        )
                    )
                }
                
                // Â≠óÊï∏Áµ±Ë®àÂíåÂª∫Ë≠∞
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween,
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = when {
                            lookingFor.isEmpty() -> "ÊèèËø∞ÊÇ®Â∏åÊúõË™çË≠òÁöÑ‰∫∫"
                            lookingFor.length < 20 -> "ÂèØ‰ª•ÂÜçË©≥Á¥∞‰∏Ä‰∫õÔºàËá≥Â∞ë20Â≠óÔºâ"
                            lookingFor.length >= 20 -> "ÊèèËø∞ÂæóÂæàÊ∏ÖÊ•öÔºÅ"
                            else -> ""
                        },
                        style = MaterialTheme.typography.bodySmall,
                        color = when {
                            lookingFor.isEmpty() -> MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                            lookingFor.length < 20 -> Color(0xFFFF9800)
                            else -> Color(0xFF4CAF50)
                        }
                    )
                    
                    Text(
                        text = "${lookingFor.length}/300",
                        style = MaterialTheme.typography.bodySmall,
                        color = when {
                            lookingFor.length > 270 -> Color(0xFFE53E3E)
                            lookingFor.length >= 20 -> Color(0xFF4CAF50)
                            else -> MaterialTheme.colorScheme.onSurface.copy(alpha = 0.6f)
                        }
                    )
                }
            }

            // ÊèêÁ§∫ÊñáÂ≠ó
            Text(
                text = stringResource(R.string.setup6_hint),
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface.copy(alpha = 0.7f),
                modifier = Modifier.padding(top = 8.dp)
            )
        }
    }
}

@Composable
@Preview(showSystemUi = true)
fun Setup6ScreenPreview() {
    MakeItSoTheme {
        Setup6ScreenContent(
            aboutMe = "ÊàëÊòØ‰∏ÄÂÄãÁÜ±ÊÑõÂ≠∏ÁøíÊñ∞ÊäÄË°ìÁöÑËªüÈ´îÂ∑•Á®ãÂ∏´ÔºåÂñúÊ≠°Èñ±ËÆÄ„ÄÅÊóÖË°åÂíåÊîùÂΩ±„ÄÇÂπ≥ÊôÇÂñúÊ≠°ÂèÉËàáÈñãÊ∫êÂ∞àÊ°àÔºåÂ∏åÊúõËÉΩÈÄèÈÅéÊäÄË°ìËÆì‰∏ñÁïåËÆäÂæóÊõ¥ÁæéÂ•Ω„ÄÇ",
            lookingFor = "Â∞ãÊâæÂøóÂêåÈÅìÂêàÁöÑÂ§•‰º¥Ôºå‰∏ÄËµ∑Ë®éË´ñÊäÄË°ì„ÄÅÂàÜ‰∫´Á∂ìÈ©ó„ÄÇ",
            isFormValid = true,
            onAboutMeChange = { },
            onLookingForChange = { },
            getAboutMeCharacterCount = { "87/500" },
            getLookingForCharacterCount = { "24/300" },
            onNext = { },
            onBack = { }
        )
    }
}

@Composable
@Preview(showSystemUi = true)
fun Setup6ScreenEmptyPreview() {
    MakeItSoTheme {
        Setup6ScreenContent(
            aboutMe = "",
            lookingFor = "",
            isFormValid = false,
            onAboutMeChange = { },
            onLookingForChange = { },
            getAboutMeCharacterCount = { "0/500" },
            getLookingForCharacterCount = { "0/300" },
            onNext = { },
            onBack = { }
        )
    }
}